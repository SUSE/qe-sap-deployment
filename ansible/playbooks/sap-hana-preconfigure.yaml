---
- name: SAP HANA Preconfigure
  hosts: hana
  remote_user: cloudadmin
  become: true
  become_user: root
  vars:
    scale_out: false
    use_sapconf: false
    saptune_solution: HANA
    platform: azure
    cluster_node: true

  pre_tasks:

    - name: Include variables
      ansible.builtin.include_vars: ./vars/hana_preconfigure.yaml
      tags:
        - test

  tasks:

  # Ensure required installation of required packages
    - name: Ensure libssl 2.1 is installed on distributed Systems
      community.general.zypper:
        name: libssh2-1 # Caution, no version control here (yet)
        state: present
      when: scale_out | bool

    # https://jira.suse.com/browse/TEAM-6887
    - name: Update old SAPHanaSR on SLE 15-SP1
      ansible.builtin.command: zypper -n in --replacefiles 'SAPHanaSR=0.154.0'
      when:
        - ansible_facts['distribution_version'] == '15.1'
      register: result
      until: result is succeeded
      retries: 3
      delay: 60

    # 3018133 - Linux: Running SAP applications compiled with GCC 10.x
    - name: Ensure minimum version of GCC10 are installed on SLE12
      community.general.zypper:
        name: "{{ item }}"
        state: present
        oldpackage: true
      loop:
        - 'libgcc_s1=10.2.1+git583-1.3.5'
        - 'libstdc++6=10.2.1+git583-1.3.5'
        - 'libatomic1=10.2.1+git583-1.3.5'
      when:
        - ansible_facts['distribution_version'] == '12.4' or
          ansible_facts['distribution_version'] == '12.5'
      register: result
      until: result is succeeded
      retries: 3
      delay: 60

    - name: Ensure minimum version of GCC10 are installed on SLE 15-SP[123]
      community.general.zypper:
        name: "{{ item }}"
        state: present
        oldpackage: true
      loop:
        - 'libgcc_s1=10.2.1+git583-1.3.4'
        - 'libstdc++6=10.2.1+git583-1.3.4'
        - 'libatomic1=10.2.1+git583-1.3.4'
      when:
        - ansible_facts['distribution_version'] == '15.1' or
          ansible_facts['distribution_version'] == '15.2' or
          ansible_facts['distribution_version'] == '15.3'
      register: result
      until: result is succeeded
      retries: 3
      delay: 60

    - name: Ensure minimum version of GCC10 are installed on SLE 15-SP4
      community.general.zypper:
        name: "{{ item }}"
        state: present
        oldpackage: true
      loop:
        - 'libgcc_s1=11.2.1+git610-150000.1.6.6'
        - 'libstdc++6=11.2.1+git610-150000.1.6.6'
        - 'libatomic1=11.2.1+git610-150000.1.6.6'
      when:
        - ansible_facts['distribution_version'] == '15.4'
      register: result
      until: result is succeeded
      retries: 3
      delay: 60

    - name: DEBUGGERS
      ansible.builtin.debug:
        msg: "psmisc={{ (psmiscVersionMatrix | selectattr('os', 'equalto', ansible_facts['distribution_version']) | json_query('[].version'))[0] }}"

    - name: Ensure that the version of psmisc meets minimum requirements
      community.general.zypper:
        name: "psmisc={{ (psmiscVersionMatrix | selectattr('os', 'equalto', ansible_facts['distribution_version']) | json_query('[].version'))[0] }}"
        state: present

    - name: Configure sapconf based systems
      ansible.builtin.include_tasks: ./tasks/sapconf.yaml
      when: use_sapconf | bool

    # saptune to be handled here with more included tasks!
    - name: Configure saptune based systems
      ansible.builtin.include_tasks: ./tasks/saptune.yaml
      when: not use_sapconf | bool

  handlers:
    - name: Reboot
      ansible.builtin.reboot:
