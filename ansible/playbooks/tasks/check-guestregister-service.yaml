---
- name: "Pre-registration: Handle Cloud Guest Register Race Condition"
  block:

    - name: Wait for cloud guest registration to finish in PAYG
      ansible.builtin.command: systemctl show guestregister.service --property=ActiveState --property=Result  # noqa: command-instead-of-module
      register: guestregister_service_state
      until:
        - guestregister_service_state.rc == 0
        - '"ActiveState=inactive" in guestregister_service_state.stdout'
        - '"Result=success" in guestregister_service_state.stdout'
      retries: 60
      delay: 10
      changed_when: false
      when: not to_be_registered

  rescue:
    - name: Get guestregister.service status
      ansible.builtin.command: systemctl status guestregister.service  # noqa command-instead-of-module
      register: guestregister_systemctl_status
      changed_when: false
      failed_when: false

    - name: Get guestregister.service definition
      ansible.builtin.command: systemctl cat guestregister.service # noqa command-instead-of-module
      register: guestregister_service_definition
      changed_when: false
      failed_when: false
      when: guestregister_systemctl_status.failed | default(false)

    - name: Get journalctl for guestregister.service
      ansible.builtin.command: journalctl -u guestregister.service --no-pager
      register: guestregister_logs
      changed_when: false
      failed_when: false

    - name: Handle guestregister.service failure with status 1
      when: '"code=exited, status=1" in guestregister_systemctl_status.stdout'
      block:
        - name: Set guestregister ExecStart command fact
          ansible.builtin.set_fact:
            guestregister_exec_start: "{{ guestregister_service_definition.stdout | regex_search('^ExecStart=(.*)$', '\\1') | first | trim }}"
          when: guestregister_service_definition.stdout is defined

        - name: Analyze guestregister service dependencies
          ansible.builtin.command: systemd-analyze critical-chain guestregister.service
          register: guestregister_deps
          changed_when: false
          failed_when: false

        - name: Get guestregister version
          ansible.builtin.command: guestregister --version
          register: guestregister_version
          changed_when: false
          failed_when: false

        - name: Get guestregister package
          ansible.builtin.command: rpm -q cloud-regionsrv-client  # noqa command-instead-of-module
          register: guestregister_package
          changed_when: false
          failed_when: false

    - name: Handle guestregister.service failure with status 67
      when: '"code=exited, status=67" in guestregister_systemctl_status.stdout'
      block:
        - name: Set guestregister service user
          ansible.builtin.set_fact:
            guestregister_user: "{{ guestregister_service_definition.stdout | regex_search('^User=(.*)$', '\\1') | first | trim }}"
          when: guestregister_service_definition.stdout is defined

        - name: Check if guestregister user exists
          ansible.builtin.command: "id {{ guestregister_user }}"
          register: guestregister_user_exists
          changed_when: false
          failed_when: false
          when: guestregister_user is defined and guestregister_user | length > 0

    - name: Check for corrupted registration file
      ansible.builtin.stat:
        path: /etc/zypp/credentials.d/SCCcredentials
      register: scc_credentials_stat

    - name: Check SCCcredentials file
      when:
        - scc_credentials_stat.stat is defined
        - scc_credentials_stat.stat.exists
      block:
        - name: SCCcredentials is empty
          ansible.builtin.debug:
            msg: "SCCcredentials is empty. Please delete the file and re-run registration."
          when: scc_credentials_stat.stat.size == 0

        - name: SCCcredentials has wrong permissions or owner
          ansible.builtin.debug:
            msg: "SCCcredentials has wrong permissions or owner. Expected root:root and 0640, got {{ scc_credentials_stat.stat.pw_name }}:{{ scc_credentials_stat.stat.gr_name }} and {{ scc_credentials_stat.stat.mode }}. Please correct permissions."
          when: >
            scc_credentials_stat.stat.pw_name != 'root' or
            scc_credentials_stat.stat.gr_name != 'root' or
            scc_credentials_stat.stat.mode != '0640'

    - name: "Scan logs for Zypper Lock Error"
      ansible.builtin.set_fact:
        lock_error_log_line: "{{ guestregister_logs.stdout_lines | select('search', 'System management is locked by the application with pid') | list | last | default('') }}"

    - name: "Extract PID from error log"
      ansible.builtin.set_fact:
        locking_pid: "{{ lock_error_log_line | regex_search('pid ([0-9]+)', '\\1') | first }}"
      when: lock_error_log_line | length > 0

    - name: "Get history of the locking PID"
      ansible.builtin.shell: |
        journalctl _PID={{ locking_pid }} --no-pager --lines=50
      register: pid_history
      when: locking_pid is defined
      changed_when: false

    - name: "Report Findings about locked PID"
      ansible.builtin.debug:
        msg:
          - "Lock Error Found: {{ lock_error_log_line | default('None found') }}"
          - "Culprit PID History: {{ pid_history.stdout_lines | default('No history found') }}"

    - name: Fail if guestregister.service is not in the expected state
      ansible.builtin.assert:
        that: false
        fail_msg: "FATAL: guestregister.service is not in the expected state (inactive/success) after retries. Check logs above for details."
